# Quick Start Guide

## Prerequisites

- Go 1.21 or higher (for development)
- Optional: MongoDB (if you want to use MongoDB storage instead of JSON)

**Note:** No OpenSSL required - RSA keys generated using pure Go crypto!

## Installation & Setup

1. **Run the development setup script:**
   ```bash
   ./setup.sh
   ```
   
   This single command does **everything**:
   - Creates necessary directories
   - Downloads Go dependencies
   - Builds the application
   - **Runs interactive setup wizard:**
     - Generates RSA key pairs (pure Go, no OpenSSL)
     - Creates `config.toml` with your preferences
     - Sets up storage backend
     - Creates admin user
     - Creates OAuth clients (optional)

2. **Start the server:**
   ```bash
   ./bin/openid-server
   # or
   make run
   ```

3. **Verify it's running:**
   ```bash
   curl http://localhost:8080/health
   # Should return: {"status":"ok"}
   ```

**That's it!** Everything is configured and ready to use.

## Testing the OpenID Flow

### Option 1: Use the Test Client

```bash
# In a new terminal, start the test client
go run examples/test-client.go
```

Then open http://localhost:9090 in your browser and follow the flow.

### Option 2: Manual Testing

1. **Discovery:**
   ```bash
   curl http://localhost:8080/.well-known/openid-configuration
   ```

2. **Get JWKS:**
   ```bash
   curl http://localhost:8080/.well-known/jwks.json
   ```

3. **Authorization (in browser):**
   ```
   http://localhost:8080/authorize?client_id=YOUR_CLIENT_ID&redirect_uri=http://localhost:9090/callback&response_type=code&scope=openid%20profile%20email&state=test123
   ```
   
   Login with: `testuser` / `password123`

4. **Exchange code for tokens:**
   ```bash
   curl -X POST http://localhost:8080/token \
     -u "CLIENT_ID:CLIENT_SECRET" \
     -d "grant_type=authorization_code&code=AUTH_CODE&redirect_uri=http://localhost:9090/callback"
   ```

5. **Get user info:**
   ```bash
   curl http://localhost:8080/userinfo \
     -H "Authorization: Bearer ACCESS_TOKEN"
   ```

## Project Structure

```
openid-golang/
├── cmd/
│   └── server/
│       └── main.go              # Application entry point
├── internal/
│   ├── config/
│   │   └── config.go            # Configuration management
│   ├── crypto/
│   │   ├── jwt.go               # JWT generation & validation
│   │   └── utils.go             # Crypto utilities (PKCE, password hashing)
│   ├── handlers/
│   │   ├── handlers.go          # Base handlers
│   │   ├── authorize.go         # Authorization endpoint
│   │   ├── token.go             # Token endpoint
│   │   ├── userinfo.go          # UserInfo endpoint
│   │   └── discovery.go         # Discovery & JWKS endpoints
│   ├── middleware/
│   │   └── middleware.go        # HTTP middleware
│   ├── models/
│   │   └── models.go            # Data models
│   └── storage/
│       ├── storage.go           # Storage interface
│       ├── mongodb.go           # MongoDB implementation
│       └── json.go              # JSON file implementation
├── scripts/
│   └── seed.go                  # Database seeding script
├── examples/
│   └── test-client.go           # Test OAuth client
├── docs/
│   ├── API.md                   # API documentation
│   ├── STORAGE.md               # Storage backends guide
│   └── TESTING.md               # Testing guide
├── config/
│   └── keys/                    # RSA keys (generated by setup)
├── config.toml.example          # Example configuration
├── go.mod                       # Go module file
├── Makefile                     # Build commands
├── setup.sh                     # Setup script
└── README.md                    # Main documentation
```

## Configuration

### Using config.toml (Recommended)

Create `config.toml` in the project root (see `config.toml.example`):

```toml
issuer = "http://localhost:8080"

[server]
host = "0.0.0.0"
port = 8080

[storage]
type = "json"  # or "mongodb"
json_file_path = "data.json"
# For MongoDB:
# type = "mongodb"
# mongo_uri = "mongodb://localhost:27017/openid"

[jwt]
private_key_path = "config/keys/private.key"
public_key_path = "config/keys/public.key"
expiry_minutes = 60
```

### Using Environment Variables (Legacy)

Alternatively, configure via environment variables:

- `SERVER_HOST` - Server host (default: 0.0.0.0)
- `SERVER_PORT` - Server port (default: 8080)
- `STORAGE_TYPE` - Storage type: json or mongodb (default: json)
- `JSON_FILE_PATH` - JSON file path (default: data.json)
- `MONGO_URI` - MongoDB connection URI (for mongodb storage)
- `JWT_PRIVATE_KEY` - Path to RSA private key
- `JWT_PUBLIC_KEY` - Path to RSA public key
- `JWT_EXPIRY_MINUTES` - Token expiry in minutes (default: 60)
- `ISSUER` - OIDC issuer URL (default: http://localhost:8080)

### Storage Backends

**JSON File Storage (Default):**
- Simple file-based storage
- Perfect for development and small deployments
- No external dependencies
- Data stored in `data.json`

**MongoDB Storage:**
- Production-grade database
- Recommended for high-traffic applications
- Supports clustering and replication
- See [Storage Documentation](STORAGE.md) for details

## OpenID Connect Endpoints

- **Discovery:** `GET /.well-known/openid-configuration`
- **JWKS:** `GET /.well-known/jwks.json`
- **Authorization:** `GET /authorize`
- **Token:** `POST /token`
- **UserInfo:** `GET /userinfo`
- **Health:** `GET /health`

## Next Steps

1. Review the [API Documentation](API.md)
2. Read the [Storage Backends Guide](STORAGE.md)
3. Read the [Testing Guide](TESTING.md)
4. Integrate with your application
5. Customize user authentication
6. Choose storage backend for production (MongoDB recommended)
7. Configure HTTPS for production use
8. Implement proper session management
9. Add rate limiting and security hardening

## Development Commands

```bash
# Build
make build

# Run
make run

# Test
make test

# Format code
make fmt

# Clean build artifacts
make clean

# Download dependencies
make deps

# Generate new RSA keys
make generate-keys
```

## Troubleshooting

**Server won't start:**
- Check if port 8080 is already in use
- Verify RSA keys exist in `config/keys/`
- For MongoDB: ensure MongoDB server is running
- Check `config.toml` or environment variables

**Authentication fails:**
- Verify test user exists (run seed script)
- Check username and password
- Verify storage backend is accessible

**Token exchange fails:**
- Verify client credentials
- Check redirect URI matches exactly
- Ensure authorization code hasn't expired (10 minutes)

**JWT validation fails:**
- Check RSA keys are properly generated
- Verify issuer URL matches configuration

**MongoDB connection fails:**
- Verify MongoDB is running: `sudo systemctl status mongod`
- Check connection URI in `config.toml`
- Try using JSON storage instead: `./openid-server --json-store`

## Security Considerations for Production

⚠️ **This is a development/example implementation. For production:**

1. Use HTTPS (TLS/SSL)
2. Use MongoDB for scalable storage
3. Implement proper session management
4. Add rate limiting
5. Enable CSRF protection
6. Implement account lockout after failed attempts
7. Add audit logging
8. Use strong key management (HSM, KMS)
9. Implement client registration
10. Add support for client authentication methods
11. Implement proper consent screens
12. Add multi-factor authentication
13. Implement token revocation
14. Add introspection endpoint
15. See [Storage Documentation](STORAGE.md) for production storage setup

## Contributing

Feel free to submit issues and enhancement requests!

## License

MIT License
